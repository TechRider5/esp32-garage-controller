<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ESP32 Garage Controller</title>
  <script type="module">
    // Load config from external file
    import { firebaseConfig } from "./config.js";

    // Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect,
      getRedirectResult, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // Init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);
    const provider = new GoogleAuthProvider();

    // Elements
    const loginBtn   = document.getElementById("login-btn");
    const logoutBtn  = document.getElementById("logout-btn");
    const statusEl   = document.getElementById("status");
    const controlsEl = document.getElementById("controls");
    const errorEl    = document.getElementById("error");

    const showError = (err) => {
      console.error(err);
      errorEl.textContent = (err && err.code) ? `${err.code}: ${err.message}` : String(err || "");
      errorEl.style.display = "block";
    };

    // Show login by default; watchdog so UI never sticks
    loginBtn.style.display = "inline-block";
    statusEl.textContent = "Checking login…";
    let authStateFired = false;
    setTimeout(() => {
      if (!authStateFired) {
        statusEl.textContent = "Not signed in";
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        controlsEl.style.display = "none";
      }
    }, 2000);

    loginBtn.onclick = async () => {
      errorEl.style.display = "none";
      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        const fallback = [
          "auth/popup-blocked",
          "auth/operation-not-supported-in-this-environment",
          "auth/popup-closed-by-user"
        ];
        if (fallback.includes(err.code)) {
          try { await signInWithRedirect(auth, provider); }
          catch (e2) { showError(e2); }
        } else {
          showError(err);
        }
      }
    };

    logoutBtn.onclick = async () => {
      errorEl.style.display = "none";
      try { await signOut(auth); } catch (err) { showError(err); }
    };

    getRedirectResult(auth).catch(showError);

    onAuthStateChanged(auth, (user) => {
      authStateFired = true;
      if (user) {
        statusEl.textContent = `Logged in as: ${user.email}`;
        loginBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        controlsEl.style.display = "block";
      } else {
        statusEl.textContent = "Not signed in";
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        controlsEl.style.display = "none";
      }
    });

    // DB writes
    window.sendCommand = (path, value) => {
      errorEl.style.display = "none";
      set(ref(db, path), value).catch(showError);
    };
  </script>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; padding: 32px; }
    h1 { margin: 0 0 12px; font-size: 48px; }
    #controls { margin-top: 16px; }
    button { padding: 9px 14px; margin: 6px 8px 0 0; border-radius: 8px; cursor: pointer; }
    #error { margin-top: 12px; color: #b00020; display: none; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>ESP32 Garage Controller</h1>

  <p id="status">Checking login…</p>
  <button id="login-btn">Sign in with Google</button>
  <button id="logout-btn" style="display:none">Sign Out</button>

  <div id="controls" style="display:none">
    <div style="margin-top:10px;">
      <button onclick="sendCommand('ledCommand','on')">LED ON</button>
      <button onclick="sendCommand('ledCommand','off')">LED OFF</button>
      <button onclick="sendCommand('ledCommand','pulse')">LED PULSE</button>
    </div>
    <div style="margin-top:10px;">
      <button onclick="sendCommand('doorCommand','door1')">Open Door 1</button>
      <button onclick="sendCommand('doorCommand','door2')">Open Door 2</button>
    </div>
  </div>

  <div id="error"></div>
</body>
</html>
